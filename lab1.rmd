---
title: "Аналіз та прогнозування часових рядів. Лабораторна робота 1"
author: "Якушев Максим"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
## 1 Інсталяція та налаштування середовища R

Був вибран R + RStudio

## 2 Вибір датасету

Був вибран датасет Microsoft Stock з Kaggle. Цей датасет містить історичні дані по акціях Microsoft (MSFT) з 1 квітня 2015 року по 1 квітня 2021 року.

Посилання на датасет: <https://www.kaggle.com/datasets/vijayvvenkitesh/microsoft-stock-time-series-analysis>

**Датасет складається з:** 

- **Date** - дата торгів; 

- **Open** - ціна відкриття;

- **High** - максимальна ціна за день;

- **Low** - мінімальна ціна за день;

- **Close** - ціна закриття;  

- **Volume** - обсяг торгів (кількість акцій).

## 3 Візуалізація та розвідувальний аналіз

### 3.1 Завантаження даних в R

Переглянемо загальний вигляд завантаженої бази даних. Конвертуємо стовпець Date у формат дати за допомогою функції as.Date()

```{r stock}
stock <- read.csv("Microsoft_Stock.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)
stock$Date <- as.Date(stock$Date, tryFormats = c("%Y-%m-%d", "%m/%d/%Y", "%d.%m.%Y"))

print(head(stock))
```

### 3.2 Перевірка, що дані є часовим рядом

Переконаємось, що дані коректно розпізнані: стовпець Date має бути з типом date, а числові показники з типом integer або numeric

```{r}
str(stock)
```

### 3.3 Побудова графіку часового ряду

Побудуємо графік зміни ціни закриття (Close) у часі

```{r}
msft_ts <- ts(stock$Close, frequency = 252, start = c(2015, 1))
plot(msft_ts, type = "l",
     main = "Microsoft Stock Price Over Time",
     ylab = "Closing Price", xlab = "Date", xaxt = "n")

time_values <- time(msft_ts)
year_positions <- seq(2015, 2021, by = 1)
axis(1, at = year_positions, labels = year_positions)
```

### 3.4 Базовий аналіз часового ряду

а) Чи є у цих тренд? Якщо так, то який?

```{r}
decomp <- stl(msft_ts, s.window = "periodic")

plot(decomp$time.series[, "trend"], type = "l",
     main = "Trend Microsoft Stock Price",
     ylab = "Closing Price", xlab = "Date")
```

При аналізі часових рядів за період 2015 - 2021 років видно, що значення ціни закриття (Close) мають чітку довгострокову тенденцію до зростання. Це означає, що існує висхідний тренд.

б) Чи характерні для ряду сезонні зміни?

```{r}
plot(decomp, main = "STL Microsoft Stock Price")
```

На перший погляд може здатися, що сезонні зміни відсутні. Проте застосування функції STL дало змогу розкласти часовий ряд на окремі компоненти та виявити наявність сезонності. Крім того, на графіку можна виокремити такі компоненти: тренд, сезонну складову та залишкову компоненту.

в) Чи є цикли?

Як видно з графіку строгої циклічності немає, якщо і є коливанні - вони випадкові.

г) Чи змінюється з часом дисперсія?

Для оцінки змін дисперсії в часі було обчислено ковзне стандартне відхилення за 63 дня для ціни закриття акцій Microsoft. Графік ковзного стандартного відхилення дозволяє оцінити волатильність ряду у часі

```{r}
library(zoo)

rolling_sd <- rollapply(stock$Close, width = 63, FUN = sd, fill = NA)

plot(stock$Date, rolling_sd, type="l", col="purple", lwd=2,
     main="Rolling Standard Deviation of Microsoft Stock",
     xlab="Date", ylab="SD (63 days)")
```

Результати показують, що дисперсія не є сталою: у різні періоди спостерігаються як відносно спокійні проміжки з низькою волатильністю, так і періоди підвищених коливань цін. Це свідчить про наявність гетероскедастичності, тобто дисперсія ряду змінюється з часом. 

д) Що можна сказати про стаціонарність даного часового ряду? Обґрунтуйте
відповідь.

За означенням стаціонарності часового ряду маємо, що його статистичні властивості не змінюються з часом. Тобто: математичне сподівання - постійне, дисперсія - постійна, а автоковаріація залежить лише від величини лага між спостереженнями.

Як видно з графіку, часовий ряд є нестаціонарним, оскільки середнє та дисперсія змінюються з часом. Щоб переконатись, що це так, виконаємо ADF-тест та KPSS-тест.

**ADF (Augmented Dickey-Fuller) тест**: нульова гіпотеза передбачає, що ряд містить одиничний корінь (тобто є нестаціонарним).

**KPSS (Kwiatkowski–Phillips–Schmidt–Shin) тест**: нульова гіпотеза стверджує, що ряд є стаціонарним.

```{r}
library(tseries)

print(adf.test(msft_ts))
print(kpss.test(msft_ts))
```

#### Інтерпретація результатів

**ADF-тест**. Цей тест показав, що $\text{p-value} > 0.05$, отже не відхиляємо $\text{H}_0$. Як результат, ряд є нестаціонарним.

**KPSS-тест.** Цей тест показав, що $\text{p-value} < 0.05$, отже в цьому випадку відхиляємо $\text{H}_0$. Як результат, ряд є нестаціонарним.

### 3.5 Побудова корелограми (автокореляційна функція ACF)

Для цього пункту роботи повинні дати відповіді на такі питання:

- Які висновки можна зробити? 

- Чи підтверджуються припущення з минулого пункту?

Для дослідження структури залежностей у часовому ряді побудуємо графік автокореляційної функції (ACF) та дамо відповіді на поставлені питання

```{r}
acf(msft_ts,lag.max = 24, main = "ACF")
```

#### Інтерпретація результатів

Значення автокореляційної функції повільно спадають і залишаються високими навіть при великих лагах. Значення виходять за межі довірчих інтервалів. Це підтверджує, що ряд є нестаціонарним. Припущення з минулого пункту підтверджується.

### 3.6 Побудова графіку часткової автокореляційної функції PACF

Для дослідження структури залежностей у часовому ряді побудуємо графік часткової автокореляційної функції (PACF) та інтерпретуємо отримані результати.

```{r}
pacf(msft_ts, lag.max = 24, main = "PACF")
```

#### Інтерпретація результатів

Значення часткової автокореляційної функції указує на авторегресійний процес першого порядку (AR(1)). Значущий лише перший лаг означає, що кожне спостереження залежить тільки від попереднього значення, а не від більш віддалених значень у часі. 

### 3.7 Побудова та аналіз ряду перших різниць вихідного ряду, графіку, корелограми

Для усунення тренду та перевірки властивостей залишків було побудовано ряд перших різниць

```{r}
diff_data <- diff(msft_ts) 

plot(diff_data, type = "l", col = "blue", lwd = 1.5,
     main = "(diff) of Microsoft Close",
     ylab = "diff(Close)", xlab = "Date")
```

На графіку видно, що коливання набули збалансованішого вигляду та зникла явна тенденція зростання, яка була в початковому ряді. Далі перевіримо ряд на стаціонарність та застосуємо попередні тести 

```{r}
print(adf.test(diff_data))
print(kpss.test(diff_data))
```

#### Інтерпретація результатів

**ADF-тест**. Цей тест показав, що $\text{p-value} < 0.05$, отже відхиляємо $\text{H}_0$. Як результат, ряд є стаціонарним.

**KPSS-тест.** Цей тест показав, що $\text{p-value} > 0.05$, отже в цьому випадку не відхиляємо $\text{H}_0$. Як результат, ряд є стаціонарним.

Далі побудуємо ACF

```{r}
acf(diff_data,lag.max = 24, main = "ACF after first diff")
```

#### Інтерпретація результатів

Після першого диференціювання отримали стаціонарний ряд без значущих автокореляцій, що вказує на успішне усунення довгострокових залежностей та трендової компоненти.

Побудуємо PACF

```{r}
pacf(diff_data, lag.max = 24, main = "PACF after first diff")
```

Після першого диференціювання ряд став ближчим до стаціонарного. На PACF видно значну від’ємну кореляцію на лагу 1, а далі значення швидко затухають і лежать у межах довірчих інтервалів.

### 3.8 Перетворення вихідного ряду на стаціонарний та застосування інших перетворень

### Перше диференцювання

Після першого диференцювання згідно тестам ADF та KPSS отримали стаціонарний ряд.

### Логарифмування

```{r}
log_data <- log(msft_ts)
plot(log_data, main = "Log-transformed Microsoft Close")
```

Побудуємо ACF

```{r}
acf(log_data, lag.max = 24, main = "ACF")
```

#### Інтерпретація результатів

ACF залишається дуже високим на всіх лагах. Відсутнє помітне спадання автокореляцій. Всі значення значно перевищують довірчі інтервали. Очевидно, що ряд є нестаціонарним.

Побудуємо PACF

```{r}
pacf(log_data, lag.max = 24, main = "PACF")
```

#### Інтерпретація результатів

Частинна автокореляція на першому лазі становить приблизно 1.0 і значно перевищує довірчі межі.Всі лаги після першого знаходяться в межах довірчих інтервалів та близькі до нуля.

### Сезонне диференціювання

```{r}
diff_season <- diff(msft_ts, lag = 252)
plot(diff_season, main = "Seasonal Difference")
```

Побудуємо ACF

```{r}
acf(diff_season, lag.max = 24, main = "ACF")
```

#### Інтерпретація результатів

Автокореляції залишаються високими та поступово знижуються зі збільшенням лага. Всі значення ACF значно виходять за межі довірчих інтервалів на всіх лагах. ACF не демонструє швидкого затухання. Сезонне перетворення не усунуло основної проблеми нестаціонарності ряду.

Побудуємо PACF

```{r}
pacf(diff_season, lag.max = 24, main = "PACF")
```

#### Інтерпретація результатів

Частинна автокореляція на першому лазі становить близько 1.0 і значно перевищує довірчі межі. Високі значення перших лагів підтверджують, що сезонне диференціювання не усунуло нестаціонарність.

### Перетворення Box–Cox 

```{r}
library(forecast)

box_ts <- BoxCox(msft_ts, lambda = 0)
plot(box_ts, main = "Box–Cox transformation")
```

Побудуємо ACF

```{r}
acf(box_ts, lag.max = 24, main = "ACF")
```

#### Інтерпретація результатів

Автокореляції залишаються максимально високими на всіх лагах. Особо не демонструє жодного помітного зменшення зі збільшенням лага. Перетворення Box-Cox не усунуло нестаціонарність, тому необхідне звичайне диференціювання.

Побудуємо PACF

```{r}
pacf(box_ts, lag.max = 24, main = "PACF")
```

#### Інтерпретація результатів

Частинна автокореляція на першому лазі дорівнює 1.0 і перевищує довірчі межі. Всі лаги після першого знаходяться в межах довірчих інтервалів та близькі до нуля. Перетворення не вплинуло на трендову компоненту часового ряду.

### Висновок

Було випробувано декілька методів перетворення часового ряду з метою досягнення стаціонарності: диференціювання, сезонне диференціювання, логарифмування та перетворення Бокса–Кокса. Результати перевірки показали, що лише перше диференціювання дозволило отримати стаціонарний ряд. У випадку застосування логарифмування, сезонного диференціювання та перетворення Бокса–Кокса ряд залишався нестаціонарним. Таким чином, можна зробити висновок, що для даного часового ряду основним ефективним методом перетворення є саме диференціювання.